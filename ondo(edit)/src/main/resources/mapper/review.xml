<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace : 해당 mapper를 사용하는 DAO 정보 입력 -->
<mapper namespace="com.example.demo.review.ReviewDAO">

    <resultMap type="com.example.demo.review.ReviewTblVO" id="reviewMap">
        <result property="rowNum"     column="RN" />

        <result property="seq"        column="SEQ" />
        <result property="title"      column="TITLE" />
        <result property="content"    column="CONTENT" />
        <result property="regDate"    column="REGDATE" />
        <result property="userId"     column="USERID" />
        <result property="isbn"       column="ISBN" />
        <result property="viewCount"  column="VIEWCOUNT" />
    </resultMap>

    <select id="selectReviewRowCount" resultType="Integer">
        <!-- 주의 : 세미콜론(;) 사용 X  -->
        SELECT COUNT(*) FROM REVIEW_TBL
    </select>

    <select id="selectReviewList" resultMap="reviewMap">
        SELECT * FROM (SELECT rowNum RN, REVIEW_TBL.* FROM REVIEW_TBL)
        WHERE RN <![CDATA[>=]]> (#{page} * #{rowsPerPage}) + 1 AND
              RN <![CDATA[<=]]> (#{page} + 1) * #{rowsPerPage}
    </select>

    <select id="selectReviewContent" resultMap="reviewMap">
        SELECT * FROM REVIEW_TBL
        WHERE USERID=#{userId} AND SEQ=#{seq}
    </select>

    <insert id="insertOneReview">
        INSERT INTO REVIEW_TBL(SEQ, TITLE, CONTENT, REGDATE, USERID, ISBN, VIEWCOUNT) VALUES
        ((SELECT NVL(MAX(SEQ), 0)+1 AS SEQ FROM REVIEW_TBL WHERE USERID=#{userId}), #{title}, #{content}, SYSDATE, 
        #{userId}, #{isbn}, 0)
    </insert>

    <update id="updateReviewContent">
        UPDATE REVIEW_TBL SET
        TITLE=#{title}, CONTENT=#{content}
        WHERE USERID=#{userId} AND SEQ=#{seq}
    </update>

    <delete id="deleteOneReview">
        DELETE FROM REVIEW_TBL WHERE USERID=#{userId} AND SEQ=#{seq}
    </delete>

    <update id="updateReviewSeq">
        UPDATE REVIEW_TBL SET
        SEQ = (SEQ - 1)
        WHERE USERID=#{userId} AND SEQ <![CDATA[>]]> #{seq}
    </update>

    <select id="selectAllReview" resultMap="reviewMap">
        SELECT * FROM REVIEW_TBL WHERE ISBN=#{isbn}
    </select>

</mapper>